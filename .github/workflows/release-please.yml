name: Release Please

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      ref:
        description: "Target branch to prepare releases from (leave empty for default behavior)."
        required: false
        default: ""
        type: string

permissions: {}

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      prs: ${{ steps.release.outputs.prs }}

    steps:
      - name: Generate GitHub token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: generate-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repository: vacs

      - uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4.4.0
        id: release
        with:
          target-branch: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.ref != '' && github.event.inputs.ref || github.ref_name }}
          token: ${{ steps.generate-token.outputs.token }}

  update-lockfiles:
    needs: release-please
    if: ${{ needs.release-please.outputs.prs }}
    strategy:
      fail-fast: false
      matrix:
        pr: ${{ fromJson(needs.release-please.outputs.prs) }}
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: generate-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repository: vacs

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ matrix.pr.headBranchName }}
          fetch-depth: 0
          token: ${{ steps.generate-token.outputs.token }}

      - name: Rust toolchain
        # dtolnay/rust-toolchain uses branch refs as its API (e.g. @stable);
        # SHA-pinning would break on every Rust release. Not tracked by Dependabot.
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          shared-key: "ubuntu-22.04-x86_64"

      - name: Update cargo workspace lockfile
        run: cargo update -w

      - name: Setup Node (LTS)
        if: contains(join(matrix.pr.files, ','), 'vacs-client')
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: vacs-client/package-lock.json

      - name: Update npm workspace lockfile
        if: contains(join(matrix.pr.files, ','), 'vacs-client')
        working-directory: vacs-client
        run: npm install --package-lock-only

      - name: Commit updated lockfiles
        uses: planetscale/ghcommit-action@25309d8005ac7c3bcd61d3fe19b69e0fe47dbdde # v0.2.20
        with:
          commit_message: "chore(lockfile): refresh cargo & npm lockfiles after version bumps"
          repo: ${{ github.repository }}
          branch: ${{ matrix.pr.headBranchName }}
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
